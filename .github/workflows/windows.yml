name: build-windows

on:
  push:
    branches: [ "wcicd-test" ]
  pull_request:

jobs:
    build-windows-msys2:

        timeout-minutes: 15
        runs-on: windows-latest
    
        strategy:
          matrix:
            config:
              - {c: "gcc", cxx: "g++", pow_version: 0.2.2}
              # - {c: "clang", cxx: "clang++"}
    
        defaults:
          run:
            shell: msys2 {0}
    
        steps:
        - name: Checkout repository
          uses: actions/checkout@v4
          with:
            submodules: recursive
    
        - name: Setup MSYS2
          uses: eine/setup-msys2@v2
          with:
            update: true
            install: mingw-w64-x86_64-toolchain mingw-w64-x86_64-clang mingw-w64-x86_64-lld mingw-w64-x86_64-cmake make automake autoconf unzip
    
        - name: Build Miner
          run: |
            ls /mingw64/bin/*.dll
            # install pow
            MINER_SRC_DIR=$(pwd)
            POW_VERSION=${{ matrix.config.pow_version }}
            curl -sL https://codeload.github.com/bitbi-core/pow/zip/refs/tags/v${POW_VERSION} -o pow.zip
            POW_HOME=$HOME/pow
            mkdir -p $POW_HOME
            unzip pow.zip -d $POW_HOME
            cd $POW_HOME/pow-${POW_VERSION}
            mkdir build
            cd build
            cmake .. -G "Unix Makefiles" -DCMAKE_C_COMPILER=${{ matrix.config.c }} -DCMAKE_CXX_COMPILER=${{ matrix.config.cxx }}
            make -j$(nproc)

            cd $MINER_SRC_DIR
            ./autogen.sh
            ./configure CPPFLAGS=" -I$POW_HOME/pow-${POW_VERSION}/src" LIBS="-L$POW_HOME/pow-${POW_VERSION}/build -lrandomx"
            make

        - name: Upload config.log
          if: failure() # Only run this step if a previous step failed
          uses: actions/upload-artifact@v2
          with:
            name: config.log
            path: ./config.log

        - name: Upload artifact
          uses: actions/upload-artifact@v4
          with:
            name: windows-msys2-${{ matrix.config.c }}
            path: |
                /mingw64/bin/libiconv-2.dll
                /mingw64/bin/tcl86.dll
                /mingw64/bin/libbrotlicommon.dll
                /mingw64/bin/libidn2-0.dll
                /mingw64/bin/libssh2-1.dll
                /mingw64/bin/tk86.dll
                /mingw64/bin/libbrotlidec.dll
                /mingw64/bin/libintl-8.dll
                /mingw64/bin/libssl-3-x64.dll
                /mingw64/bin/libbrotlienc.dll
                /mingw64/bin/libstdc++-6.dll
                /mingw64/bin/zlib1.dll
                /mingw64/bin/libcrypto-3-x64.dll
                /mingw64/bin/libunistring-5.dll
                /mingw64/bin/libcurl-4.dll
                /mingw64/bin/libnghttp2-14.dll
                /mingw64/bin/libwinpthread-1.dll
                /mingw64/bin/libgcc_s_seh-1.dll
                /mingw64/bin/libpsl-5.dll
                /mingw64/bin/libzstd.dll
                ./minerd.exe
